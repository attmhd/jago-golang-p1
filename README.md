# Simple CRUD - Pertemuan 3

Proyek ini adalah aplikasi sederhana CRUD untuk Products, Categories, dan Transactions menggunakan Gin (web framework), dengan arsitektur terpisah: repository, service, dan handler. Aplikasi berjalan sebagai HTTP server di port 8080.

Data `products` terhubung dengan `categories` melalui `category_id` dan seluruh response untuk `GET /api/v1/products`, `GET /api/v1/products/:id`, `POST /api/v1/products`, dan `PUT /api/v1/products/:id` mengembalikan struktur JSON dengan objek `category` yang nested (berisi `id` dan `name`) berdasarkan relasi. Transactions menangani checkout dan report penjualan dengan pola response unified menggunakan `util.JSONResponse`.

## Fitur Utama

- CRUD Categories:
  - List semua kategori
  - Get kategori by ID
  - Create kategori
  - Update kategori
  - Delete kategori
- CRUD Products:
  - List semua produk dengan kategori nested
  - Get produk by ID dengan kategori nested
  - Create produk dan kembalikan kategori nested
  - Update produk dan kembalikan kategori nested
  - Delete produk
- Transactions:
  - Checkout transaksi (membuat `transactions` dan `transaction_details`, mengurangi stok produk)
  - Report ringkasan penjualan:
    - Hari ini: `GET /api/v1/report/hari-ini`
    - Rentang tanggal: `GET /api/v1/report?start_date=YYYY-MM-DD&end_date=YYYY-MM-DD`
    - Response seragam dengan pola `util.JSONResponse`
- Health check endpoint untuk monitoring
- API Docs (Swagger/OpenAPI) dengan UI Scalar
- Struktur kode modular:
  - `repository` untuk akses data (PostgreSQL via `database/sql`)
  - `service` untuk business logic
  - `handler` untuk HTTP layer (Gin)
  
## Struktur Proyek

```
pertemuan-1/
  ├─ config/
  │  └─ config.go               // Konfigurasi aplikasi (DB, port, dll.)
  ├─ database/
  │  └─ database.go             // Inisialisasi koneksi database
  ├─ docs/
  │  └─ swagger.json            // Dokumentasi API (generated by swag)
  ├─ handler/
  │  ├─ category.go             // HTTP handlers (Gin) untuk kategori
  │  ├─ product.go              // HTTP handlers (Gin) untuk produk, response nested category
  │  ├─ transaction.go          // HTTP handlers (Gin) untuk transaksi: checkout & report
  │  └─ response.go             // DTO untuk response Product/Category
  ├─ models/
  │  ├─ category.go             // Definisi struct entity Category
  │  ├─ product.go              // Definisi struct entity Product (termasuk CategoryID & CategoryName)
  │  └─ transaction.go          // Definisi struct entity Transaction & TransactionDetail
  ├─ repository/
  │  ├─ category.go             // Implementasi repository Category (DB)
  │  ├─ product.go              // Implementasi repository Product (DB, JOIN category)
  │  └─ transaction.go          // Implementasi repository transaksi (create & ringkasan penjualan)
  ├─ service/
  │  ├─ category.go             // Business logic dan interface CategoryService
  │  ├─ product.go              // Business logic dan interface ProductService
  │  └─ transaction.go          // Business logic transaksi (checkout & ringkasan penjualan)
  ├─ util/
  │  └─ util.go                 // Utility functions, termasuk JSONResponse
  └─ main.go                    // Bootstrap server, wiring repo -> service -> handler, routes
```

## Arsitektur dan Alur

1. Repository
   - `repository.ProductRepository`
     - `GetAll() ([]model.Product, error)` — SELECT dengan JOIN ke `categories` untuk mendapatkan `CategoryName`
     - `GetByID(id int) (*model.Product, error)` — SELECT dengan JOIN untuk satu produk
     - `Create(product *model.Product) (*model.Product, error)` — INSERT dengan `RETURNING id`, lalu service akan memanggil `GetByID` untuk melengkapi `CategoryName`
     - `Update(product *model.Product) error` — UPDATE berdasarkan `id`
     - `Delete(id int) error` — DELETE berdasarkan `id`
   - `repository.CategoryRepository` — operasi dasar kategori (GetAll, GetByID, Create, Update, Delete)
   - `repository.TransactionRepository` — operasi transaksi (CreateTransaction, GetSalesSummary, GetTopSellingProduct, dll.)

2. Service
   - `service.ProductService`
     - `GetAll() ([]model.Product, error)`
     - `GetByID(id int) (*model.Product, error)`
     - `Create(product *model.Product) (*model.Product, error)` — setelah insert, fetch lagi dengan `GetByID` agar `CategoryName` terisi
     - `Update(product *model.Product) (*model.Product, error)` — setelah update, fetch lagi dengan `GetByID` agar `CategoryName` terisi
     - `Delete(id int) error`
   - `service.CategoryService` — abstraksi business logic kategori
   - `service.TransactionService` — business logic transaksi (checkout, ringkasan penjualan hari ini/rentang)

3. Handler
   - `handler.ProductHandler`
     - Mengubah hasil dari service (model flat) menjadi DTO dengan `category` nested:
       ```
       {
         "message": "Success",
         "data": [
           {
             "id": 1,
             "name": "Makanan",
             "price": 10000,
             "stock": 80,
             "category": {
               "id": 1,
               "name": "Test"
             }
           }
         ]
       }
       ```
     - Struktur response yang sama diterapkan untuk `GetById`, `Create`, dan `Update`
   - `handler.CategoryHandler` — endpoints dasar kategori
   - `handler.TransactionHandler` — endpoints checkout dan report dengan pola `util.JSONResponse`

4. `main.go`
   - Inisialisasi:
     - `db` (sql.DB) untuk koneksi PostgreSQL
     - `repo := repository.NewProductRepository(db)`, `repository.NewCategoryRepository(db)`, `repository.NewTransactionRepository(db)`
     - `svc := service.NewProductService(repo)`, `service.NewCategoryService(repo)`, `service.NewTransactionService(repo)`
     - `h := handler.NewProductHandler(svc)`, `handler.NewCategoryHandler(svc)`, `handler.NewTransactionHandler(svc)`
   - Routing Gin dengan prefix `/api/v1` untuk API endpoints, dan server run di `:8080`.

## Persiapan Lingkungan

- Go 1.20+ (disarankan)
- Database: PostgreSQL (atau kompatibel dengan sintaks `RETURNING`)
- `database/sql` dan driver PostgreSQL (mis. `github.com/lib/pq`) di `go.mod`
- Module path project: `simple-crud` (disesuaikan dengan `import` yang digunakan)
- Tools tambahan: `swag` untuk generate API docs (`go install github.com/swaggo/swag/cmd/swag@latest`)

Pastikan `go.mod` sesuai dan import path di file-file:
- `simple-crud/config`
- `simple-crud/database`
- `simple-crud/handler`
- `simple-crud/models`
- `simple-crud/repository`
- `simple-crud/service`
- `simple-crud/util`

## Menjalankan Aplikasi

1. Posisikan terminal di direktori `pertemuan-1`.
2. Jalankan:
   - `go run main.go`

Server akan berjalan di `http://localhost:8080`.

### API Docs (Swagger / OpenAPI)
- Generator:
  - Pastikan sudah install `swag` (contoh): `go install github.com/swaggo/swag/cmd/swag@latest`
  - Generate docs dari root project: `swag init -g pertemuan-1/main.go -o pertemuan-1/docs`
- Akses:
  - JSON spec: `GET /openapi.json`
  - UI: `GET /docs`
- Catatan:
  - Handler transactions sudah dilengkapi anotasi pada endpoint:
    - `POST /api/v1/checkout`
    - `GET /api/v1/report/hari-ini`
    - `GET /api/v1/report?start_date=YYYY-MM-DD&end_date=YYYY-MM-DD`
  - Respons mengacu ke `util.JSONResponse` dengan `data` berupa `model.Transaction` (checkout) atau `handler.SalesSummaryResp` (report).

## API Endpoints

- Health
  - GET `/health`
    - Response: `{"status":"ok"}`

- Categories
  - GET `/api/v1/categories`
    - Response: unified dengan `util.JSONResponse`
  - GET `/api/v1/categories/:id`
    - Params: `id` (int > 0)
    - Response: unified atau `404` saat tidak ditemukan
  - POST `/api/v1/categories`
    - Body JSON:
      ```
      {
        "name": "New Cat"
      }
      ```
    - Response: unified dengan data kategori yang dibuat
  - PUT `/api/v1/categories/:id`
    - Params: `id` (int > 0)
    - Body JSON:
      ```
      {
        "name": "Updated Name"
      }
      ```
    - Response: unified dengan data kategori yang diperbarui
  - DELETE `/api/v1/categories/:id`
    - Params: `id` (int > 0)
    - Response: unified dengan status OK jika sukses, `404` jika tidak ditemukan

- Products
  - GET `/api/v1/products`
    - Response: daftar produk dengan kategori nested (pola unified menggunakan `util.JSONResponse`)
      ```
      {
        "message": "Success",
        "data": [
          {
            "id": 1,
            "name": "Makanan",
            "price": 10000,
            "stock": 80,
            "category": {
              "id": 1,
              "name": "Test"
            }
          }
        ]
      }
      ```
  - GET `/api/v1/products/:id`
    - Params: `id` (int > 0)
    - Response: satu produk dengan kategori nested atau `404`
  - POST `/api/v1/products`
    - Body JSON:
      ```
      {
        "category_id": 1,
        "name": "Minuman",
        "price": 5000,
        "stock": 30
      }
      ```
    - Proses: INSERT, lalu service akan `GetByID` untuk melengkapi `category.name`
    - Response: produk yang dibuat dengan kategori nested
  - PUT `/api/v1/products/:id`
    - Params: `id` (int > 0)
    - Body JSON:
      ```
      {
        "category_id": 2,
        "name": "Minuman Segar",
        "price": 6000,
        "stock": 40
      }
      ```
    - Proses: UPDATE, lalu service akan `GetByID` untuk melengkapi `category.name`
    - Response: produk yang diperbarui dengan kategori nested
  - DELETE `/api/v1/products/:id`
    - Params: `id` (int > 0)
    - Response: Status OK jika sukses, `404` jika tidak ditemukan

- Transactions
  - POST `/api/v1/checkout`
    - Body JSON:
      ```
      {
        "items": [
          { "product_id": 1, "quantity": 2 },
          { "product_id": 3, "quantity": 1 }
        ]
      }
      ```
    - Response sukses (unified):
      ```
      {
        "message": "Checkout berhasil",
        "data": {
          "id": 10,
          "total_amount": 30000,
          "created_at": "2026-01-02T10:00:00Z",
          "details": [
            { "id": 1, "transaction_id": 10, "product_id": 1, "product_name": "Produk A", "quantity": 2, "subtotal": 20000 },
            { "id": 2, "transaction_id": 10, "product_id": 3, "product_name": "Produk C", "quantity": 1, "subtotal": 10000 }
          ]
        }
      }
      ```
  - GET `/api/v1/report/hari-ini`
    - Deskripsi: Ringkasan penjualan hari ini.
    - Response (unified):
      ```
      {
        "message": "Sales summary",
        "data": {
          "total_revenue": 12345,
          "total_transaksi": 7,
          "produk_terlaris": {
            "nama": "Produk A",
            "qty_terjual": 15
          }
        }
      }
      ```
  - GET `/api/v1/report?start_date=YYYY-MM-DD&end_date=YYYY-MM-DD`
    - Deskripsi: Ringkasan penjualan berdasarkan rentang tanggal.
    - Query params:
      - `start_date` (opsional, format YYYY-MM-DD)
      - `end_date` (opsional, format YYYY-MM-DD)
    - Response (unified) sama dengan endpoint hari ini, tetapi dihitung berdasarkan rentang.

### Pola JSON Response (Unified)
- Sukses:
  ```
  {
    "message": "Success atau deskriptif",
    "data": ...
  }
  ```
- Error:
  ```
  {
    "message": "Alasan error",
    "data": null
  }
  ```

## Contoh curl

- Health check
  - `curl -s http://localhost:8080/health`

- List categories
  - `curl -s http://localhost:8080/api/v1/categories | jq`

- List products
  - `curl -s http://localhost:8080/api/v1/products | jq`

- Get product by id
  - `curl -s http://localhost:8080/api/v1/products/1 | jq`

- Create product
  - `curl -s -X POST http://localhost:8080/api/v1/products -H "Content-Type: application/json" -d '{"category_id":1,"name":"Minuman","price":5000,"stock":30}' | jq`

- Update product
  - `curl -s -X PUT http://localhost:8080/api/v1/products/1 -H "Content-Type: application/json" -d '{"category_id":2,"name":"Minuman Segar","price":6000,"stock":40}' | jq`

- Delete product
  - `curl -s -X DELETE http://localhost:8080/api/v1/products/1 -w " HTTP %{http_code}\n"`

- Checkout transaction
  - `curl -s -X POST http://localhost:8080/api/v1/checkout -H "Content-Type: application/json" -d '{"items":[{"product_id":1,"quantity":2}]}' | jq`

- Report hari ini
  - `curl -s http://localhost:8080/api/v1/report/hari-ini | jq`

- Report rentang tanggal
  - `curl -s "http://localhost:8080/api/v1/report?start_date=2026-01-01&end_date=2026-01-31" | jq`

## Catatan

- Pastikan `categories` berisi data yang valid sebelum membuat `products`, karena `category_id` harus merujuk ke `categories.id`.
- Implementasi repository `products` menggunakan JOIN untuk mengisi `CategoryName`. Service `Create` dan `Update` akan memanggil `GetByID` setelah operasi tulis untuk memastikan respons memiliki `category.name` yang benar.
- Untuk transactions, pastikan tabel `transactions` dan `transaction_details` memiliki kolom `created_at` (default NOW()) untuk filter tanggal.
- Jika database bukan PostgreSQL, sesuaikan cara mendapatkan `ID` hasil insert (misalnya dengan `LastInsertId()` jika driver mendukung).
- Semua response menggunakan pola unified `util.JSONResponse` untuk konsistensi.
